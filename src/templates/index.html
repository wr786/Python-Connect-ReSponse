<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~ Python Connect Re:Sponse ~</title>
    <link rel='stylesheet prefetch'
        href='https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/components/icon.min.css'>
    <link href="{{ url_for('static',filename='css/semantic.min.css') }}" rel="stylesheet" type="text/css">
    <script src="{{ url_for('static',filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/semantic.min.js') }}"></script>

    <link href="{{url_for('static',filename='css/highlight.css')}}" rel='stylesheet' type="text/css">

    <link href="{{ url_for('static',filename='css/general.css') }}" rel="stylesheet" type="text/css">
</head>

<body leftmargin="0" topmargin="0" scroll="no">
    <div id="root" class="ui container">

        <h2 class="ui center aligned icon header">
            <i class="pink edit icon"></i>
            <b id="title" style="color: #F72D81; font-family:Consolas;">~ Python Connect Re:Sponse ~</b>
        </h2>

        <div id="result" class="ui hidden positive message"><i class="close icon" onclick="eraseMessage(this)"></i></div>

        <div class="ui form">
            <div class="field">
                <div id="codearea" contenteditable="false" onclick="hideCodearea()" style="visibility:hidden"></div>
                <label>Edit your CODE here:</label>
                <textarea id="edit" rows="25"></textarea>
            </div>

            <div id="runBtn" class="ui blue labeled submit icon button" onclick="runScript()">
                <i class="icon code"></i>Run Code!
            </div>
            <div id="help" class="ui violet labeled icon button" onclick="showHint()">
                <i class="icon info"></i>Help
            </div>
            <div id="clear" class="ui red labeled icon button" onclick="clearCode()">
                <i class="icon trash"></i>Clear Code
            </div>

            <div class="field">
                <label>Input data:</label>
                <textarea id="inputData"" rows="5"></textarea>
            </div>
        </div>

        <div id="loading" class="ui icon message" style="visibility: hidden;">
            <i class="notched circle loading icon"></i>
            <div class="content">
                <div class="header">
                    Please wait...
                </div>
                <p>Compiling & Running</p>
            </div>
        </div>

    </div>

    <script>

        var onTextareaKeydown = function (e) {
            if (e.keyCode == 9) {
                e.preventDefault();
                var start = this.selectionStart,
                    end = this.selectionEnd;
                var text = this.value;
                var tab = '    ';
                text = text.substr(0, start) + tab + text.substr(start);
                this.value = text;
                this.selectionStart = start + tab.length;
                this.selectionEnd = end + tab.length;
            } else if (e.keyCode == 13 && e.shiftKey) {
                runScript();
            } else if (e.keyCode == 18) {
                addHighLight();
            }
        }
        document.getElementById('edit').onkeydown = onTextareaKeydown;

        function eraseMessage(that) {
            $(that).closest(".message").transition('fade');
        }

        function hideCodearea() { // 隐藏高亮代码
            $("#codearea").html("");
            $("#codearea").css("visibility", "hidden");
            $("#edit").attr("rows", "25")
        }

        function addHighLight() { // 加高光
            code = $("#edit").val();
            var sendData = {
                code
            };
            $.post('/highlight', sendData, function (rtnSvr) {
                $("#codearea").html(rtnSvr);
                $("#codearea").css("visibility", "visible");
            })
            $("#edit").attr("rows", "12");
        }

        function runScript() {
            $("#loading").css("visibility", "visible");
            code = $("#edit").val();
            inputData = $("#inputData").val();
            var sendData = {
                code,
                inputData
            };
            $.post('/runScript', sendData, function (rtnSvr) {
                var rtnval = rtnSvr[0];
                var result = rtnSvr.substr(1);
                result = result.replaceAll("\n", "<br/>")
                if(rtnval == "0") {
                    $("#result").html('<i class="close icon" onclick="eraseMessage(this)"></i>' + '<div class="header">Result:</div>' + result + '');
                    $("#result").removeClass("hidden");
                    $("#result").removeClass("negative");
                    $("#result").addClass("positive");
                } else {
                    $("#result").html('<i class="close icon" onclick="eraseMessage(this)"></i>' + '<div class="header">Error:</div>' + result + '');
                    $("#result").removeClass("hidden");
                    $("#result").removeClass("positive");
                    $("#result").addClass("negative");
                }
            })
            $("#loading").css("visibility", "hidden");
        }

        function clearCode() {
            $("#edit").val("");
        }


        String.prototype.replaceAll  = function(s1,s2){   
            return this.replace(new RegExp(s1,"gm"),s2);   
        }

    </script>

</body>

</html>